var NO_JQUERY={};
(function(a,b,d){if(!("console"in a)){var c=a.console={};c.log=c.warn=c.error=c.debug=function(){}}b===NO_JQUERY&&(b={fn:{},extend:function(){for(var a=arguments[0],b=1,e=arguments.length;b<e;b++){var c=arguments[b],h;for(h in c)a[h]=c[h]}return a}});b.fn.pm=function(){console.log("usage: \nto send: $.pm(options)\nto receive: $.pm.bind(type, fn, [origin])");return this};b.pm=a.pm=function(a){e.send(a)};b.pm.bind=a.pm.bind=function(a,b,l,c,h){e.bind(a,b,l,c,!0===h)};b.pm.unbind=a.pm.unbind=function(a,
b){e.unbind(a,b)};b.pm.origin=a.pm.origin=null;b.pm.poll=a.pm.poll=200;var e={send:function(a){a=b.extend({},e.defaults,a);var q=a.target;if(a.target)if(a.type){var l={data:a.data,type:a.type};a.success&&(l.callback=e._callback(a.success));a.error&&(l.errback=e._callback(a.error));"postMessage"in q&&!a.hash?(e._bind(),q.postMessage(JSON.stringify(l),a.origin||"*")):(e.hash._bind(),e.hash.send(a,l))}else console.warn("postmessage type required");else console.warn("postmessage target window required")},
bind:function(a,b,l,c,h){e._replyBind(a,b,l,c,h)},_replyBind:function(f,c,l,d,h){"postMessage"in a&&!d?e._bind():e.hash._bind();d=e.data("listeners.postmessage");d||(d={},e.data("listeners.postmessage",d));var n=d[f];n||(n=[],d[f]=n);n.push({fn:c,callback:h,origin:l||b.pm.origin})},unbind:function(a,b){var c=e.data("listeners.postmessage");if(c)if(a)if(b){var d=c[a];if(d){for(var h=[],n=0,t=d.length;n<t;n++){var p=d[n];p.fn!==b&&h.push(p)}c[a]=h}}else delete c[a];else for(n in c)delete c[n]},data:function(a,
b){return b===d?e._data[a]:e._data[a]=b},_data:{},_CHARS:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),_random:function(){for(var a=[],b=0;32>b;b++)a[b]=e._CHARS[0|32*Math.random()];return a.join("")},_callback:function(a){var b=e.data("callbacks.postmessage");b||(b={},e.data("callbacks.postmessage",b));var c=e._random();b[c]=a;return c},_bind:function(){e.data("listening.postmessage")||(a.addEventListener?a.addEventListener("message",e._dispatch,!1):a.attachEvent&&a.attachEvent("onmessage",
e._dispatch),e.data("listening.postmessage",1))},_dispatch:function(a){try{var b=JSON.parse(a.data)}catch(c){console.warn("postmessage data invalid json: ",c);return}if(b.type){var d=(e.data("callbacks.postmessage")||{})[b.type];if(d)d(b.data);else for(var d=(e.data("listeners.postmessage")||{})[b.type]||[],h=0,n=d.length;h<n;h++){var t=function(n){b.callback&&e.send({target:a.source,data:n,type:b.callback})},p=d[h];if(p.origin&&"*"!==p.origin&&a.origin!==p.origin)console.warn("postmessage message origin mismatch",
a.origin,p.origin),b.errback&&e.send({target:a.source,data:{message:"postmessage origin mismatch",origin:[a.origin,p.origin]},type:b.errback});else try{p.callback?p.fn(b.data,t,a):t(p.fn(b.data,a))}catch(c){if(b.errback)e.send({target:a.source,data:c,type:b.errback});else throw c;}}}else console.warn("postmessage message type required")},hash:{send:function(b,c){var d=b.target,m=b.url;if(m){var m=e.hash._url(m),h,n=e.hash._url(a.location.href);if(a==d.parent)h="parent";else try{for(var t=0,p=parent.frames.length;t<
p;t++)if(parent.frames[t]==a){h=t;break}}catch(r){h=a.name}null==h?console.warn("postmessage windows must be direct parent/child windows and the child must be available through the parent window.frames list"):(h={"x-requested-with":"postmessage",source:{name:h,url:n},postmessage:c},n="#x-postmessage-id="+e._random(),d.location=m+n+encodeURIComponent(JSON.stringify(h)))}else console.warn("postmessage target window url is required")},_regex:/^\#x\-postmessage\-id\=(\w{32})/,_regex_len:50,_bind:function(){e.data("polling.postmessage")||
(setInterval(function(){var b=""+a.location.hash,c=e.hash._regex.exec(b);c&&(c=c[1],e.hash._last!==c&&(e.hash._last=c,e.hash._dispatch(b.substring(e.hash._regex_len))))},b.pm.poll||200),e.data("polling.postmessage",1))},_dispatch:function(b){if(b){try{if(b=JSON.parse(decodeURIComponent(b)),!("postmessage"===b["x-requested-with"]&&b.source&&null!=b.source.name&&b.source.url&&b.postmessage))return}catch(c){return}var d=b.postmessage,m=(e.data("callbacks.postmessage")||{})[d.type];if(m)m(d.data);else{var h;
h="parent"===b.source.name?a.parent:a.frames[b.source.name];for(var m=(e.data("listeners.postmessage")||{})[d.type]||[],n=0,t=m.length;n<t;n++){var p=function(a){d.callback&&e.send({target:h,data:a,type:d.callback,hash:!0,url:b.source.url})},r=m[n];if(r.origin){var z=/https?\:\/\/[^\/]*/.exec(b.source.url)[0];if("*"!==r.origin&&z!==r.origin){console.warn("postmessage message origin mismatch",z,r.origin);d.errback&&e.send({target:h,data:{message:"postmessage origin mismatch",origin:[z,r.origin]},type:d.errback,
hash:!0,url:b.source.url});continue}}try{r.callback?r.fn(d.data,p):p(r.fn(d.data))}catch(c){if(d.errback)e.send({target:h,data:c,type:d.errback,hash:!0,url:b.source.url});else throw c;}}}}},_url:function(a){return(""+a).replace(/#.*$/,"")}}};b.extend(e,{defaults:{target:null,url:null,type:null,data:null,success:null,error:null,origin:"*",hash:!1}})})(this,"undefined"===typeof jQuery?NO_JQUERY:jQuery);"JSON"in window&&window.JSON||(JSON={});
(function(){function a(a){return 10>a?"0"+a:a}function b(a){e.lastIndex=0;return e.test(a)?'"'+a.replace(e,function(a){var b=l[a];return"string"===typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function d(a,n){var c,e,r,l,w=f,u,g=n[a];g&&"object"===typeof g&&"function"===typeof g.toJSON&&(g=g.toJSON(a));"function"===typeof m&&(g=m.call(n,a,g));switch(typeof g){case "string":return b(g);case "number":return isFinite(g)?String(g):"null";case "boolean":case "null":return String(g);
case "object":if(!g)return"null";f+=q;u=[];if("[object Array]"===Object.prototype.toString.apply(g)){l=g.length;for(c=0;c<l;c+=1)u[c]=d(c,g)||"null";r=0===u.length?"[]":f?"[\n"+f+u.join(",\n"+f)+"\n"+w+"]":"["+u.join(",")+"]";f=w;return r}if(m&&"object"===typeof m)for(l=m.length,c=0;c<l;c+=1)e=m[c],"string"===typeof e&&(r=d(e,g))&&u.push(b(e)+(f?": ":":")+r);else for(e in g)Object.hasOwnProperty.call(g,e)&&(r=d(e,g))&&u.push(b(e)+(f?": ":":")+r);r=0===u.length?"{}":f?"{\n"+f+u.join(",\n"+f)+"\n"+
w+"}":"{"+u.join(",")+"}";f=w;return r}}"function"!==typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(b){return this.getUTCFullYear()+"-"+a(this.getUTCMonth()+1)+"-"+a(this.getUTCDate())+"T"+a(this.getUTCHours())+":"+a(this.getUTCMinutes())+":"+a(this.getUTCSeconds())+"Z"},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(a){return this.valueOf()});var c=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
e=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,f,q,l={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},m;"function"!==typeof JSON.stringify&&(JSON.stringify=function(a,b,c){var e;q=f="";if("number"===typeof c)for(e=0;e<c;e+=1)q+=" ";else"string"===typeof c&&(q=c);if((m=b)&&"function"!==typeof b&&("object"!==typeof b||"number"!==typeof b.length))throw Error("JSON.stringify");return d("",{"":a})});
"function"!==typeof JSON.parse&&(JSON.parse=function(a,b){function e(a,c){var d,p,g=a[c];if(g&&"object"===typeof g)for(d in g)Object.hasOwnProperty.call(g,d)&&(p=e(g,d),void 0!==p?g[d]=p:delete g[d]);return b.call(a,c,g)}var d;c.lastIndex=0;c.test(a)&&(a=a.replace(c,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(a.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,
"")))return d=eval("("+a+")"),"function"===typeof b?e({"":d},""):d;throw new SyntaxError("JSON.parse");})})();(function(a){a.wa_blog.editor={options:{blogs:{},content_id:"post_text",current_blog_id:null,dateMonthCount:2,dateShowWeek:!1,cut_link_label_default:"",version:"1.0"},transliterated:!1,blog_statuses:{"private":"private","public":"public"},init:function(b){function d(b){a(this).show();a(this).parent().find(".datetime").hide();b&&a("#current-time").text(b);a("#current-time").show()}function c(a){var b=a.siblings(".hint:first");0>=b.length&&(b=a.parent().siblings(".hint:first"));return b}function e(a){a.parent().find("input[type=text]").removeClass("error");
c(a).removeClass("errormsg")}function f(a){a.parent().find("input[type=text]").addClass("error");c(a).addClass("errormsg")}function q(){return a.datepicker._defaults.dateFormat.toUpperCase().replace("YY","YYYY")}var l=this;l.options=a.extend(l.options,b);l.postUrlWidget=function(){function b(c,d,e,n){var g=null,p={post_title:e,post_id:d,blog_id:c},l=[c,d].join("&");!h[l]||!f&&e?(f&&(p.slug=f),a.ajax({url:"?module=post&action=getPostUrl",data:p,dataType:"json",type:"post",async:!1,success:function(b){g=
b.data;h[l]=g;a.wa_blog.editor.transliterated=!0;n(g)}})):n(h[l])}function c(b){var d=b.link+b.slug+"/";a("#url-link").text(d);a("#url-link").attr("href",b.preview_hash?d+"?preview="+b.preview_hash:d);a("#pure-url").text(b.link);a("#pure-url").data("preview-url",b.preview_link);b.slug&&!f?(a("#post-url").val(b.slug),f=b.slug):a("#post-url").val(f);var e=b.is_adding?"small":b.is_published?"small":"hint",n=a("#post-url-field span:first").contents().filter(function(){return 3==this.nodeType}).get(0).nodeValue;
if(b.other_links&&b.other_links instanceof Array){d=[];for(k in b.other_links)d.push({previewText:n,className:e,slug:f,link:b.other_links[k],preview_link:b.other_preview_links[k],href:b.preview_hash?b.other_links[k]+f+"/?preview="+b.preview_hash:b.other_links[k]+f+"/"});b=b.is_adding?'<span class="${className}">${previewText}${link}<span class="slug">{{if slug}}${slug}/{{/if}}</span></span><br>':'<span class="${className}">${previewText}<a target="_blank" href="${href}" data-preview-url="${preview_link}">${link}<span class="slug">{{if slug}}${slug}/{{/if}}</span></a></span><br>';
e=a("#post-url-field").children(":first");e.is(".icon10")&&(b='<i class="'+e.attr("class")+'"></i> '+b);a("#other-urls").html(a.tmpl(b,d))}}function d(b){b=b||"hidden";"empty"==b?a("#post-url-field-no-settlements").show("fast"):a("#post-url-field-no-settlements").hide("fast");f=null;var c=a("#post-url").val("");"empty"==b||"hidden_empty"==b?c.siblings('[name="update_url_on_error"]').length||c.after(a.parseHTML('<input type="hidden" name="update_url_on_error" value="1">')):c.siblings('[name="update_url_on_error"]').remove();
a("#post-url-field").hide("fast").trigger(a.Event("change",{status:b}))}function e(b,c){b&&(f=b);a(".slug").each(function(){if(f){var b=a(this).text(f+"/").parents("a:first");b.attr("href",b.text()+(c?"?preview="+c:""))}else a(this).text("")})}function l(){a("#url-editable").hide();a("#url-edit").show();a("#post-url").focus()}var f=null,h={},g=function(){},m={};(function(){var h=g=function(){if(a("#post-url-field").length){var e=a("#post-title").val(),g=a("input[name=blog_id]").val();if(m[g]&&m[g].no_frontend)e?
d("empty"):d("hidden_empty");else{e||d("hidden");var f=a("input[name=post_id]").val();b(g,f,e,function(b){b&&(m[g]||(m[g]={id:g,no_frontend:b.is_private_blog||!b.link}),m[g].no_frontend?e?d("empty"):d("hidden_empty"):e?(a("#post-url-field-no-settlements").hide("fast"),b&&c(b),a("#post-url-field").show("fast").trigger(a.Event("change",{status:"visible"}))):(c(b),d("hidden")))})}}else d("empty")};a("#post-title").blur(h);a("#post-form").find("input[name=post_id]").val()&&h();a("#url-edit-link").click(l);
a("#post-url").keyup(function(a){9!=a.keyCode&&this.value!=f&&e(this.value)})})();return{setEditReady:l,resetEditReady:function(){a("#url-editable").show();a("#url-edit").hide()},updateSlugs:e,changeBlog:g}}();l.inlineSaveController=function(b){function c(){!1!==m()&&d(g)}function d(b){var c=a.wa_blog.editor.wysiwygToHtml(a("#post_text","#post-form").val());a("#post_text","#post-form").val(c);c=a("#post-form").serialize()+"&"+l+"=1";c+=h?"&inline=1":"";c+=a.wa_blog.editor.transliterated?"":"&transliterate=1";
b=b||function(){};e("loading");a.ajax({url:"?module=post&action=save",data:c,dataType:"json",type:"post",success:function(c){if("fail"==c.status){c.errors.datetime||a.wa_blog.editor.closeCurrentDialog();var d=c.errors;if(d.url){a("#post-url-field").show();var n=a("#post-url"),g=d.url,p="#message-"+n.attr("id");n.addClass("error");a(p).addClass("errormsg").text(g)}d.datetime&&(d=a(".datepicker:not(:disabled)"),d.length&&f(d));c.errors.datetime||"deadline"!=l||((c=a("#deadline-dialog .datepicker").val())?
a("#publication-deadline-changable-part").html(a.tmpl("publication-deadline-setted",{date:c})):a("#publication-deadline-changable-part").html(a.tmpl("publication-deadline-setted")),a("#b-post-save-draft-button").attr("name","deadline"))}else c.data.redirect?location.href=c.data.redirect:(b(c.data),c.data.id&&a("#post-id").val(c.data.id),e("saved"));h=!1;e("")},error:function(a,b,c){}})}function e(b,c){b?(a("#form-status span").hide(),a("#form-status #"+b+"-status").show(),a("#form-status").show()):
a("#form-status").fadeOut(c&&"function"==typeof c?c:function(){})}b=b||{};var l="",h=!1,m=b.beforeSave||function(){},g=b.afterSave||function(){};(function(){a("input[type=submit], input[type=button], a.js-submit").click(function(){if(a(this).hasClass("dialog-edit"))return!1;if(a(this).hasClass("js-submit")){var b=a(this).attr("title")||a(this).text()||"Are you sure?";if(!confirm(b))return!1}!a("#post-id").val()||"b-post-save-button"!=this.id&&"b-post-save-draft-button"!=this.id&&"b-post-save-custom-params"!=
this.id||(h=!0);l=this.name;"deadline"!=l&&"schedule"!=l||a("#"+this.name+"-dialog").find("input[name^=datetime]").attr("disabled",!1);c();return!1});a("#post-url").focus(function(){})})();return{save:c,setAction:function(a){l=a},getAction:function(){return l}}}({beforeSave:function(){var b=a(".datepicker:not(:disabled)"),c=!0;if(0<b.length){var d=b.parent(".datetime").find(".time");if(0<d.length){var e;if(e=d.get(0))e=d.eq(0).val(),e=!(0<=e&&24>=e);e&&(c=!1);if(e=d.get(1))d=d.eq(1).val(),e=!(0<=
d&&60>=d);e&&(c=!1)}c||f(b)}if(!c)return!1;a.wa_blog.editor.onSubmit()},afterSave:function(b){a("#b-post-save-button").removeClass("yellow").addClass("green");a("#postpublish-edit").removeClass("yellow").addClass("green");l.postUrlWidget.resetEditReady();l.postUrlWidget.updateSlugs(b.url,b.preview_hash||!1);d.call(a("#inline-edit-datetime").get(0),b.formatted_datetime);"draft"==l.inlineSaveController.getAction()&&a("#post-url-field .small").removeClass("small").addClass("hint");b=a("#b-post-edit-custom-params-dialog");
if(!b.is(":hidden")){var c=b.find(":input[name=meta_title]").val(),e=b.find(":input[name=meta_keywords]").val(),f=b.find(":input[name=meta_description]").val(),h=b.find(":input[name=params]").val();c?a("#b-post-edit-meta-title").show().find(".val").text(c):a("#b-post-edit-meta-title").hide();e?a("#b-post-edit-meta-keywords").show().find(".val").text(e):a("#b-post-edit-meta-keywords").hide();f?a("#b-post-edit-meta-description").show().find(".val").text(f):a("#b-post-edit-meta-description").hide();
h?a("#b-post-edit-custom-params").show().html(h.trim().split("\n").join("<br>")+"<br>"):a("#b-post-edit-custom-params").hide();c||e||f||h?a("#b-post-edit-no-meta").hide():a("#b-post-edit-no-meta").show();b.trigger("close")}}});(function(){function b(){var c="#"+this.id+"-on-label",d="#"+this.id+"-off-label";this.checked?(a(c).removeClass("b-unselected"),a(d).addClass("b-unselected")):(a(c).addClass("b-unselected"),a(d).removeClass("b-unselected"))}var c=a("#allow-comment-switcher");b.call(c.get(0));
c.iButton({labelOn:"",labelOff:"",className:"mini"}).change(b)})();(function(b){b={changeMonth:!0,changeYear:!0,shortYearCutoff:2,showOtherMonths:2>b.dateMonthCount,selectOtherMonths:2>b.dateMonthCount,stepMonths:b.dateMonthCount,numberOfMonths:b.dateMonthCount,showWeek:b.dateShowWeek,gotoCurrent:!0,constrainInput:!1,beforeShow:function(){setTimeout(function(){10>a("#ui-datepicker-div").css("z-index")&&a("#ui-datepicker-div").css("z-index",10)},0)}};a(".datepicker").datepicker(b).filter("input[name^=schedule_datetime]").datepicker("option",
"minDate",new Date);a("#ui-datepicker-div").hide();a(".datepicker").focus(function(){e(a(this))})})(l.options);(function(){function b(){var c=a(this).attr("id").replace(/-.*$/,"");a.wa_blog.editor.currentDialog=a("#"+c+"-dialog").waDialog({disableButtonsOnSubmit:!0,onLoad:function(){a(this).find("input,select").removeAttr("disabled");a(".user-date-format").text(q())},onSubmit:function(){return!1},onCancel:function(b){a(this).find("input:text,select").each(function(b){a(this).value=a(this).defaultValue;
a(this).attr("disabled","disabled")})}});return!1}a(".dialog-edit").each(function(){a(this).click(function(a){a.preventDefault();return b.call(a.target)})})})();b=null;try{b=a.storage.get("blog/editor")||"redactor"}catch(m){this.log("Exception: "+m.message+"\nline: "+m.fileName+":"+m.lineNumber)}if(!b||!this.editors[b])for(b in this.editors)break;if(!this.selectEditor(b,!0))for(b in this.editors)if(this.selectEditor(b,!0))break;a("#post-form").find("input[name=post_id]").val()||a("#post-title").focus();
a.wa.dropdownsCloseEnable();a(".change-blog").click(a.wa_blog.editor.changeBlogHandler);a('#postpublish-dialog input[name="publish_blog_id"]').change(a.wa_blog.editor.changePublishBlogHandler);a("#post-title").keyup(function(){var b=a(this),c=b.next(".maxlength"),d=parseInt(b.attr("maxlength"));d&&b.val().length>=d&&!c.length?b.after('<em class="hint maxlength">'+$_("input_maxlength").replace(/%d/,d)+"</em>"):(!d||b.val().length<d)&&c.length&&c.remove()});a("#inline-edit-datetime").click(function(){a(this).hide();
a(this).parent().find(".datetime").show();a("#current-time").hide();a(".user-date-format").text(q())});a(".b-post-editor-toggle li a").click(this.editorTooggle);a(document).keydown(function(a){if(a.ctrlKey&&83==a.keyCode)l.onSaveHotkey(a)});a(".time").focus(function(){e(a(this).parent().find(".datepicker"))});a("#post-form").submit(function(){return!1});a("#b-post-edit-custom-params-link").click(function(){a("#b-post-edit-custom-params-dialog").waDialog({onSubmit:function(){return!1}});return!1});
var h=a(window);a("#buttons-bar").sticky&&a("#buttons-bar").sticky({fixed_class:"b-fixed-button-bar",isStaticVisible:function(a,b){return h.scrollTop()+h.height()>=a.element.offset().top+a.element.outerHeight()}});(function(){function b(c){a.pm({target:g[0].contentWindow,type:"update_title",data:c})}function c(){var a=e();a&&a!=g.attr("src")&&(g.attr("src",a),g.one("load",function(){}))}function d(a){return a.data("preview-url")||""}function e(){var b=null;a("#post-url-field a").each(function(){var c=
d(a(this));if(c&&"javascript:"!=c.substr(0,11)){if(g.attr("src")==c)return b=null,!1;b=c}});b||(b=g.attr("src"),"about:blank"==b&&(b=null));return b}function f(){!a("#post-url-field-no-settlements").is(":visible")&&e()?(g.show(),x.hide(),v=!0,c()):(g.hide(),x.show(),v=!1);E.val("1");q=!0;var b=a.storage.get("blog/editor/preview_sidebar_width")||600,d=a(".sidebar").hide().first().width()-0;h.closest(".content").animate({marginLeft:0},400);y.css({"min-width":0,right:d+16+"px"}).animate({left:"15px",
right:b-0+15+"px"},400);h.find(".content").animate({marginRight:b+"px"},400);m.css("width",0).show().animate({width:b+"px"},400);D.slideUp(400);setTimeout(function(){q=!1;a(window).resize().scroll()},410)}function l(){E.val("");var b=a(".sidebar"),c=b.first().width()-0;q=!0;var d=h.closest(".content").animate({marginLeft:c+"px"},400),e=h.find(".content").animate({marginRight:c+"px"},400);m.hide();D.slideDown(400);y.animate({left:c+15+"px",right:c+16+"px"},400);setTimeout(function(){b.show();m.hide();
q=!1;d.css("marginLeft","");e.css("marginRight","");y.css({left:"",right:""});a(window).resize().scroll()},410)}var h=a("#post-form"),g=a("#realtime-preview-iframe"),m=g.closest(".sidebar"),q=!1,C=a("<textarea>").hide().appendTo(m),A=a("#post-title"),x=a("#not-available-message"),D=a("#wa-header"),y=a(".b-fixed-button-bar"),F=a('#blog-photo_bridge-editor [name="album_id"]'),E=m.find('[name="realtime_on"]'),v=!1,B=!1;g.one("load",function(){B=!0});a.pm.bind("updater_loaded",function(a){B=!0});a.widget("ui.blog_draghandler",
a.ui.mouse,{_init:function(){this._mouseInit();this.$content=h.find(".content")},_mouseStart:function(b){this.xStart=b.pageX;this.sidebar_width=m.width();this.window_width=a(window).width();v&&g.hide()},_mouseDrag:function(b){this.sidebar_width+=this.xStart-b.pageX;this.xStart=b.pageX;320>this.sidebar_width?this.sidebar_width=320:380>this.window_width-this.sidebar_width&&(this.sidebar_width=this.window_width-380);m.width(this.sidebar_width);this.$content.css({marginRight:this.sidebar_width+"px"});
y.css("right",this.sidebar_width+16+"px");a(window).resize()},_mouseStop:function(){v&&g.show();a.storage.set("blog/editor/preview_sidebar_width",this.sidebar_width)}});m.find(".column-resize-handler:first").blog_draghandler();a("#realtime-preview-toggle").click(function(){q||(h.hasClass("realtime-edit-mode")?(h.removeClass("realtime-edit-mode"),a(this).removeClass("b-close-live-editor"),l()):(h.addClass("realtime-edit-mode"),a(this).addClass("b-close-live-editor"),f()))});A.keyup(function(){b(A.val())});
setInterval(function(){if(B&&h.hasClass("realtime-edit-mode")){var c=null;(c=a("#post-form .b-post-editor-toggle li.selected a").attr("id"))&&a.wa_blog.editor.editors[c]&&a.wa_blog.editor.editors[c].update(C);b(A.val());c=C.val();F.val()&&(c=c+'<p class="attached-album-description"><em>'+$_("Photos from the attached album will be displayed here."),c+="</em></p>");a.pm({target:g[0].contentWindow,type:"update_text",data:c})}},500);a("#post-url-field").on("click","a",function(){if(h.hasClass("realtime-edit-mode")){var b=
d(a(this));b!=g.attr("src")&&(g.attr("src",b),g.one("load",function(){}));return!1}});a("#post-url-field").change(function(a){h.hasClass("realtime-edit-mode")&&("empty"!=a.status&&"hidden_empty"!=a.status?(g.show(),x.hide(),v=!0,c()):(g.hide(),x.show(),v=!1))});a(window).resize(function(){g.height(a(window).height()-30);g.width(m.width()-10)})})()},cloneTextarea:function(b,d,c){var e="editor_container_"+c;a(d).append(b.clone(!0).attr({id:e,name:"text_"+c,disabled:!0}));b.hide();return e},cut_hr:'<span class="b-elrte-wa-split-vertical elrte-wa_post_cut">%text%</span>',
cut_str:"\x3c!-- more %text%--\x3e",htmlToWysiwyg:function(b){return b.replace(/\x3c!--[\s]*?more[\s]*?(text[\s]*?=[\s]*?['"]([\s\S]*?)['"])*[\s]*?--\x3e/g,function(b,c,e){return e?a.wa_blog.editor.cut_hr.replace("%text%",e):a.wa_blog.editor.cut_hr.replace("%text%",a.wa_blog.editor.options.cut_link_label_default)})},wysiwygToHtml:function(b){var d=a("<p></p>").html(b),c=d.find(".elrte-wa_post_cut");return c.length?((b=c.html())&&"<br>"!==b&&b!==a.wa_blog.editor.options.cut_link_label_default?c.replaceWith(a.wa_blog.editor.cut_str.replace("%text%",
'text="'+b+'" ')):c.replaceWith(a.wa_blog.editor.cut_str.replace("%text%","")),d.html().replace("<span></span>","")):b},editors:{ace:{editor:null,container:null,inited:!1,init:function(b){if(!this.inited){this.inited=!0;this.container=a('<div id="blog-ace-editor"></div>').appendTo("#post_text_wrapper");this.container.wrap('<div class="ace"></div>');this.editor=ace.edit("blog-ace-editor");ace.config.set("basePath",wa_url+"wa-content/js/ace/");this.editor.setTheme("ace/theme/eclipse");var d=this.editor.getSession();
d.setMode("ace/mode/javascript");d.setMode("ace/mode/css");d.setMode("ace/mode/html");d.setMode("ace/mode/smarty");d.setUseWrapMode(!0);this.editor.$blockScrolling=Infinity;this.editor.renderer.setShowGutter(!1);this.editor.setShowPrintMargin(!1);this.editor.setFontSize(13);a(".ace_editor").css("fontFamily","");d.setValue(b.hide().val());this.editor.moveCursorTo(0,0);-1!=navigator.appVersion.indexOf("Mac")?this.editor.setFontSize(13):-1!=navigator.appVersion.indexOf("Linux")?this.editor.setFontSize(16):
this.editor.setFontSize(14);this.editor.commands.addCommand({name:"unfind",bindKey:{win:"Ctrl-F",mac:"Command-F"},exec:function(a,b){return!1},readOnly:!0});var c=a("#post-form .sidebar .b-edit-options:first").height(),e=function(b,d){var e=b.getSession().getScreenLength()*b.renderer.lineHeight+b.renderer.scrollBar.getWidth(),e=1.02*e,f=c-163;e<f&&(e=f);a("#"+d).height(e.toString()+"px");b.resize()},f=this,q=a(window);d.on("change",function(){e(f.editor,"blog-ace-editor");q.scroll()});setTimeout(function(){e(f.editor,
"blog-ace-editor")},50);q.resize(function(){f.editor.resize();e(f.editor,"blog-ace-editor")});this.container.on("keydown",a.wa_blog.editor.editorKeyCallback());this.container.on("keypress",a.wa_blog.editor.editorKeyCallback(!0))}return!0},show:function(b){this.container.show();this.container.parent().show();if(this.editor){b=b.val();b=a.wa_blog.editor.wysiwygToHtml(b);var d=this.editor.getCursorPosition();this.editor.setValue(b);a("#post-title").is(":focus")||this.editor.focus();this.editor.navigateTo(d.row,
d.column)}else"object"==typeof console&&console.log("wait for ace editor init"),this.show(b)},hide:function(){this.container.hide();this.container.parent().hide()},update:function(a){this.inited&&a.val(this.editor.getValue())},correctEditorHeight:function(b){return Math.max(b,a.wa_blog.editor.getMinEditorHeight())+a.wa_blog.editor.getExtHeightShift()}},redactor:{options:{},inited:!1,callback:!1,editor:null,init:function(b){if(!this.inited){var d=a(window),c=a("#b-post-save-button"),e=a("#postpublish-edit");
a("#post-form .sidebar .b-edit-options:first").height();var f=a.extend({focus:!0,deniedTags:!1,minHeight:300,linkify:!1,source:!1,paragraphy:!1,replaceDivs:!1,toolbarFixed:!0,replaceTags:{b:"strong",i:"em",strike:"del"},removeNewlines:!1,removeComments:!1,imagePosition:!0,imageResizable:!0,imageFloatMargin:"1.5em",buttons:"format bold italic underline deleted lists image video file table link alignment fontcolor fontsize fontfamily".split(" "),plugins:"fontcolor fontfamily alignment fontsize table video cut".split(" "),
lang:wa_lang,imageUpload:"?action=upload&r=2&absolute=1",imageUploadFields:b.data("uploadFields"),changeCallback:function(){e.is(":visible")&&e.removeClass("green").addClass("yellow");c.is(":visible")&&c.removeClass("green").addClass("yellow");d.scroll()}},f||{});f.callbacks=a.extend({imageUploadError:function(a){console.log("imageUploadError",a);alert(a.error)},syncBefore:function(a){return a=a.replace(/{[a-z$][^}]*}/gi,function(a,b,c){var d=c.indexOf("\x3c/script",b+a.length);b=c.indexOf("<script",
b+a.length);if(-1==d||-1!=b&&b<d)a=a.replace(/&gt;/g,">"),a=a.replace(/&lt;/g,"<"),a=a.replace(/&amp;/g,"&"),a=a.replace(/&quot;/g,'"');return a})}},f.callbacks||{});a.wa_blog_options.photos_bridge_available&&(f.callbacks.modalOpened=function(b,c){if("image"==b){var d=this;this.modal.width=1100;var e=this.modal.getModal(),f=a('<div id="photos-image-selector-wrapper">'),t=a('<div class="redactor-modal-tab redactor-tab1" data-title="'+$_("Select from Photos app")+'">').hide().append(f).append('<div class="clear-both">'),
p=t.find(".total-photos-selected");e.append(t);this.modal.buildTabber();(function(){function b(){f.find("input:checkbox").each(function(){e[this.value]&&a(this).prop("checked",!0).change()});a(window).resize()}var c=0,e={},h=a('<button id="redactor-modal-button-action" style="margin-top: 16px;">'+d.lang.get("insert")+"</button>").hide();t.append(h);var g=a('<button id="redactor-modal-button-cancel" style="margin-top: 16px;">'+d.lang.get("cancel")+"</button>").hide();t.append(g);a('#redactor-modal-tabber a[rel="1"]').on("click",
function(){h.is(":visible")||(h.show(),g.show(),f.html('<div class="block"><i class="icon16 loading"></i></div>'),a.post("../photos/?module=photo&action=embedSelector",{app_id:"blog"},function(a){f.html(a);b()}))});g.off("click").on("click",function(){d.modal.close()});h.on("click",function(){if(0<c){var b=[];a.each(e,function(a,c){b.push('<figure><img src="'+c+'"></figure>')});d.insert.html(b.join("\n"))}d.modal.close()});a('#redactor-modal-tabber a[rel="0"]').on("click",function(){h.hide();g.hide()});
f.on("change","input:checkbox",function(){var b=a(this),d=b.val();this.checked?e[d]||(e[d]=b.data("photoUrl"),c++):e[d]&&(delete e[d],c--);0<c?p.text(c).closest(".hidden").show():p.text(c).closest(".hidden").hide()});f.on("reloaded",function(a){b()})})()}});b.redactor(f);b.redactor("core.box").css("z-index",0);b.redactor("core.toolbar").css("z-index",1);this.editor=b.data("redactor");this.inited=!0}return!0},show:function(b){var d=a.wa_blog.editor.htmlToWysiwyg(b.val());b.val(d);a(".redactor-box").show();
b.redactor("core.editor").find('img[src*="$wa_url"]').each(function(){var b=decodeURIComponent(a(this).attr("src"));a(this).attr("data-src",b);a(this).attr("src",b.replace(/\{\$wa_url\}/,wa_url))});this.editor.code.set(b.val());this.editor.observe.load();this.editor.focus.start()},hide:function(b){a(".redactor-box").hide()},update:function(b){if(this.inited){var d=this.editor.code.get(),d=this.editor.clean.onSync(this.editor.clean.onSet(d)),d=a.wa_blog.editor.wysiwygToHtml(d);b.val(d)}}},photo_bridge:{container:null,
inited:!1,init:function(b){if(!this.inited){this.inited=!0;b.hide();this.container=a("#blog-photo_bridge-editor");if(!this.container.length)return;var d=a("#album-frontend-link"),c=this.container.find('select[name="album_id"]'),e=this.container.find(".hidden.field"),f=0;c.change(function(){if(c.val()){var b=c.children(":selected").data("frontend-link");b?(e.slideDown(f),d.text(b)):(e.slideUp(f),e.find('[name="album_link_type"]:checkbox').prop("checked",!1));a("#post-editor .show-when-album-selected").show()}else e.slideUp(f),
a("#post-editor .show-when-album-selected").hide()}).change();f=300;b=a("#post-form .sidebar .b-edit-options:first").height();this.container.css("min-height",b-100)}return!0},show:function(a){this.container.show()},hide:function(){this.container.hide()},update:function(a){}}},getMinEditorHeight:function(){return 200},getExtHeightShift:function(){return-70},editorTooggle:function(){var b=a(this);!b.hasClass("selected")&&a.wa_blog.editor.selectEditor(b.attr("id"))&&(a(".b-post-editor-toggle li.selected").removeClass("selected"),
b.parent().addClass("selected"));return!1},selectEditor:function(b,d){if(this.editors[b]){var c=a("#"+this.options.content_id);if(c.length){try{if(this.editors[b].init(c)){var e=null;if(!d)try{a.storage.set("blog/editor",b)}catch(f){this.log("Exception: "+f.message+"\nline: "+f.fileName+":"+f.lineNumber)}var q=a(".b-post-editor-toggle li.selected a");q.length&&(q.parent().removeClass("selected"),e=q.attr("id"))&&(this.editors[e].update(c),this.editors[e].hide());a("#"+b).parent().addClass("selected");
this.editors[b].show(c);setTimeout(function(){a(window).scroll()},0)}}catch(f){return this.log("Exception: "+f.message+"\nline: "+f.fileName+":"+f.lineNumber,f.stack),!1}return!0}this.log('Text container for "'+b+'" not found');return!1}this.log('Blog editor "'+b+'" not found');return!1},editor_key:!1,editorKeyCallback:function(b){var d=this;return b?function(b){if(b.ctrlKey&&115==b.which&&!a.wa_blog.editor.editor_key)d.onSaveHotkey(b)}:function(b){a.wa_blog.editor.editor_key=!1;b.ctrlKey&&83==b.which&&
(a.wa_blog.editor.editor_key=!0,d.onSaveHotkey(b));b.metaKey||!((33>b.which||40<b.which)&&(27<b.which||8==b.which||13==b.which)&&(112>b.which||124<b.which))||b.ctrlKey&&67==b.which||(a("#b-post-save-button").removeClass("green").addClass("yellow"),a("#postpublish-edit").removeClass("green").addClass("yellow"))}},onSubmit:function(){var b=a.wa_blog,d;for(d in b)if("editor"!=d&&b[d].onSubmit&&"function"==typeof b[d].onSubmit)try{b[d].onSubmit()}catch(c){"object"==typeof console&&console.log(c)}b=a("#"+
this.options.content_id);if(b.length){d=null;var e=a(".b-post-editor-toggle li.selected a");e.length&&(d=e.attr("id"))&&this.editors[d].update(b)}b=a("#b-post-save-button");"draft"!=b.attr("name")&&"deadline"!=b.attr("name")&&(b.removeClass("yellow").addClass("green"),a("#postpublish-edit").removeClass("yellow").addClass("green"))},onSaveHotkey:function(b){b.preventDefault();b=a("#b-post-save-draft-button");var d=a("#b-post-save-button");b.length?b.click():d.length&&d.click()},currentDialog:null,
closeCurrentDialog:function(){this.currentDialog&&this.currentDialog.waDialog().trigger("close")},registerEditor:function(a,d){if(this.editors[a])return this.log('Editor "'+a+'" already registered'),!1;this.editors[a]=d;return!0},log:function(a,d){"object"==typeof console&&(console.log(a),d&&console.log(d))},changeBlogHandler:function(){var b=parseInt(a(this).attr("href").replace(/^.*#/,""));a.wa_blog.editor.selectCurrentBlog(b)&&(a(".dialog :input:checked").attr("checked",!1),a(".dialog #b-post-publish-blog-"+
b).attr("checked",!0));a.wa.dropdownsClose();return!1},changePublishBlogHandler:function(){if(a(this).attr("checked")){var b=parseInt(a(this).val());a.wa_blog.editor.selectCurrentBlog(b)}},selectCurrentBlog:function(b){var d=a.wa_blog.editor.options.blogs[b],c=a.wa_blog.editor.options.current_blog_id;if(d&&c!=b){var e=a.tmpl("selected-blog",{blog:d});a(".current-blog").replaceWith(e);a("#blog-selector-"+c).removeClass("selected");e=a("#blog-selector-"+b).addClass("selected");c=a.wa_blog.editor.options.blogs[c];
a.wa_blog.editor.options.current_blog_id=parseInt(b);b=a(".b-post");c&&b.removeClass(c.color);b.addClass(d.color);a.wa_blog.editor.postUrlWidget.changeBlog(e.attr("data-blog-status"));return!0}}}})(jQuery);
//# sourceMappingURL=blog-post-edit.min.js.map